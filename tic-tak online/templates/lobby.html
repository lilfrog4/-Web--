<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–±–±–∏ - –ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏</h1>
            <div class="user-menu">
                <span class="username">–ü—Ä–∏–≤–µ—Ç, {{ username }}!</span>
                <a href="{{ url_for('stats') }}" class="stats-btn">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a href="{{ url_for('logout') }}" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </div>

        <div class="lobby-actions">
            <button onclick="createRoom()" class="lobby-btn create-btn">
                –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
            </button>
            <button onclick="showRoomList()" class="lobby-btn find-btn">
                –ù–∞–π—Ç–∏ –∫–æ–º–Ω–∞—Ç—É
            </button>
        </div>

        <div id="roomList" class="room-list" style="display: none;">
            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã:</h3>
            <div id="roomsContainer"></div>
            <button onclick="hideRoomList()" class="back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <div id="waitingRoom" class="waiting-room" style="display: none;">
            <h3>–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞...</h3>
            <p>ID –∫–æ–º–Ω–∞—Ç—ã: <span id="roomId"></span></p>
            <div class="loading"></div>
            <button onclick="leaveRoom()" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        function createRoom() {
            fetch('/create_room', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('roomId').textContent = data.room_id;
                        document.querySelector('.lobby-actions').style.display = 'none';
                        document.getElementById('waitingRoom').style.display = 'block';
                        checkGameStart();
                    }
                });
        }

        function showRoomList() {
            fetch('/get_rooms')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const container = document.getElementById('roomsContainer');
                        container.innerHTML = '';
                        
                        if (data.rooms.length === 0) {
                            container.innerHTML = '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</p>';
                        } else {
                            data.rooms.forEach(room => {
                                const roomElement = document.createElement('div');
                                roomElement.className = 'room-item';
                                roomElement.innerHTML = `
                                    <div class="room-info">
                                        <strong>–ö–æ–º–Ω–∞—Ç–∞ ${room.room_id}</strong>
                                        <span>–°–æ–∑–¥–∞—Ç–µ–ª—å: ${room.creator}</span>
                                    </div>
                                    <button onclick="joinRoom('${room.room_id}')" class="join-btn">
                                        –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                                    </button>
                                `;
                                container.appendChild(roomElement);
                            });
                        }
                        
                        document.querySelector('.lobby-actions').style.display = 'none';
                        document.getElementById('roomList').style.display = 'block';
                    }
                });
        }

        function hideRoomList() {
            document.getElementById('roomList').style.display = 'none';
            document.querySelector('.lobby-actions').style.display = 'block';
        }

        function joinRoom(roomId) {
            fetch(`/join_room/${roomId}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.location.href = '/game';
                    } else {
                        alert(data.message);
                        showRoomList();
                    }
                });
        }

        function leaveRoom() {
            fetch('/leave_room', { method: 'POST' })
                .then(r => r.json())
                .then(() => {
                    document.getElementById('waitingRoom').style.display = 'none';
                    document.querySelector('.lobby-actions').style.display = 'block';
                });
        }

        function checkGameStart() {
            fetch('/game_state')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success' && data.players && data.players.length === 2) {
                        window.location.href = '/game';
                    } else {
                        setTimeout(checkGameStart, 2000);
                    }
                });
        }
    </script>
</body>
</html>